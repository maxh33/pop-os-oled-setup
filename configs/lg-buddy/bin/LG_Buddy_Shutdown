#!/bin/bash

#Ignore if reboot. We only care about shutdown.
if systemctl list-jobs | grep -q -E 'reboot.target.*start'
then
    echo "Reboot; ignoring"
    exit 0
fi

#Change tv_ip to the IP Address of your TV. It's recommended to set your TV IP to static or make a DHCP reservation on your modem/router to ensure this never changes.
tv_ip="192.168.X.X"
input="HDMI_4"
BSCPYLGTV="/usr/bin/LG_Buddy_PIP/bin/bscpylgtvcommand"

# Convert HDMI_4 -> com.webos.app.hdmi4
expected_app="com.webos.app.$(echo "$input" | tr '[:upper:]' '[:lower:]' | tr -d '_')"

# Check current TV input
current_input=$("$BSCPYLGTV" "$tv_ip" get_input 2>/dev/null)
get_input_rc=$?

if [ $get_input_rc -ne 0 ] || [ -z "$current_input" ]; then
    # TV unreachable or already off. power_off is idempotent.
    echo "Could not query TV input. Proceeding with power_off."
    "$BSCPYLGTV" "$tv_ip" power_off 2>&1 || true
elif [ "$current_input" = "$expected_app" ]; then
    echo "TV is on $input. Turning off for shutdown."
    "$BSCPYLGTV" "$tv_ip" power_off 2>&1 || true
else
    echo "TV is on $current_input (not $input). Skipping."
fi
