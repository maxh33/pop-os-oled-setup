#!/bin/bash

#Script goes in /etc/NetworkManager/dispatcher.d/pre-down.d/

#We only want this to run when the network is going down due to sleep/suspend
if journalctl -u NetworkManager | tail -1 | grep -q "reason 'sleeping'"
then
    tv_ip="192.168.X.X"
    input="HDMI_4"
    STATE_DIR="/run/user/1000/lg_buddy"
    STATE_FILE="${STATE_DIR}/screen_off_by_us"
    BSCPYLGTV="/usr/bin/LG_Buddy_PIP/bin/bscpylgtvcommand"

    # Convert HDMI_4 -> com.webos.app.hdmi4
    expected_app="com.webos.app.$(echo "$input" | tr '[:upper:]' '[:lower:]' | tr -d '_')"

    # Check current TV input
    current_input=$("$BSCPYLGTV" "$tv_ip" get_input 2>/dev/null)
    get_input_rc=$?

    if [ $get_input_rc -ne 0 ] || [ -z "$current_input" ]; then
        # TV unreachable or already off. power_off is idempotent.
        echo "Could not query TV input. Proceeding with power_off."
        mkdir -p "$STATE_DIR"
        "$BSCPYLGTV" "$tv_ip" power_off 2>&1 || true
        touch "$STATE_FILE"
    elif [ "$current_input" = "$expected_app" ]; then
        echo "TV is on $input. Turning off for sleep."
        mkdir -p "$STATE_DIR"
        "$BSCPYLGTV" "$tv_ip" power_off 2>&1 || true
        touch "$STATE_FILE"
    else
        echo "TV is on $current_input (not $input). Skipping."
        rm -f "$STATE_FILE"
    fi
fi

exit 0
